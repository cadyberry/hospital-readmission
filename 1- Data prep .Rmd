---
title: "Data Prep"
author: "Acadia Berry"
date: "2024-04-25"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages

```{r load packages}
library(ggplot2)
library(psych)
library(dplyr)
library(caret)
library(tidyverse)
library(psych)
library(car)
library(plyr)
library(rpart)
library(pROC)
library(broom)
library(caret)
library(rattle)
library(smotefamily)
library(ResourceSelection)
library(comorbidity)
library(xgboost)
library(shapr)
library(rpart.plot)
library(randomForest)
library(glmnet)
library(fastDummies)
```

```{r load packages}
library(MASS)


# Define custom colors including the specified shades of purple
custom_colors <- c("#200a58", "#5236ab", "#6e3fed", "#9e83f5", "#bfb5f9", "#cbc3e6", "#e6e3f3","#ffcdd2", "#ff978a", "#e31937", "#ff7362", "#ff6a00", "#991f3d", "#650a21" )


# Set a global theme for ggplot2 
custom_theme <- theme_minimal() +
  theme(
    text = element_text(size = 12),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.background = element_rect(fill = "white"), 
    plot.background = element_rect(fill = "white"),   
    panel.grid.major = element_line(color = "gray"), 
    panel.grid.minor = element_line(color = "lightgray")  
  
  )

# Set the global theme
theme_set(custom_theme)

```

# Load Data

```{r}
#setwd("C:\\Users\\acadia.berry\\Documents\\Repositories")


df<- read.csv("diabetic_data.csv")
df_copy <- df

```

# Summary of the data

```{r}

# Check if each column is character and convert to factor if true
for (col in names(df)) {
  if (is.character(df[[col]])) {
    df[[col]] <- factor(df[[col]])
  }
}

# data set summaries 
glimpse(df)
#describe(df)
summary(df)

```

# Data Cleaning

## Missing data

```{r}
# Sum of missing columns
missing_summary <- colSums(is.na(df))

# Missing data counts:
cat("Missing data counts:\n")
cat("Payer Code:", sum(is.na(df$payer_code)), "missing\n")
cat("Weight:", sum(is.na(df$weight)), "missing\n")
cat("Age: no missing records\n")
cat("Race:", sum(is.na(df$race)), "missing\n")
cat("Medical Specialty:", sum(is.na(df$medical_specialty)), "missing\n")
cat("A1C Result:", sum(is.na(df$A1Cresult)), "missing\n")

```

## Duplicate records

```{r}

# Check for duplicate records from all columns
duplicates <- df[duplicated(df), ]

if (nrow(duplicates) == 0) {
  cat("There are no duplicate records.\n")
} else {
  cat("Duplicate records:\n")
  print(duplicates)
}

```

## Correcting data types

```{r}
# Columns to convert to factor
factor_columns <- c("race", "admission_type_id", "discharge_disposition_id", 
                    "admission_source_id", "diag_1", "diag_2", "diag_3")

# Convert selected columns to factors using lapply
df[factor_columns] <- lapply(df[factor_columns], as.factor)


```

# Variable Pre-processing

## Update *Readmitted*

-   Created a new variable named *readmit* to preserve the original
    levels of the *readmitted* variable.
-   Transformed the *readmitted* variable into a binary outcome where
    "\<30" is coded as "1" and "\>30" plus "NO" are coded as "0", making
    it suitable for binary classification.

```{r}
# Preserve original levels of readmitted as "readmit"
df$readmit <- df$readmitted

# Make readmitted binary with 1 = "<30", 0 = ">30" + "NO"
df$readmitted <- ifelse(df$readmitted == "<30", "1", "0")
df$readmitted <- as.factor(df$readmitted)

# Distribution of readmitted
cat("Original distribution of readmitted:\n")
print(table(df$readmit))

cat("\nDistribution of readmitted:\n")
print(table(df$readmitted))


```

## Update medical specialty

-   Grouped medical specialties into categories using `case_when` in R
    to create a new variable `specialty`, then verified the distribution
    and compared the unique specialties in the data set with the created
    categories.

```{r}


# Define the grouping categories
categories <- list(
  "Internal_Medicine" = c("InternalMedicine", "Hospitalist", "Resident"),
  "Emergency/Trauma" = "Emergency/Trauma",
  "Family/GeneralPractice" = "Family/GeneralPractice", 
  "Missing" = c("?", "PhysicianNotFound"),
  "Surgery" = c("Surgeon", 
                "Surgery-Cardiovascular", 
                "Surgery-Cardiovascular/Thoracic", 
                "Surgery-Colon&Rectal",
                "Surgery-General", 
                "Surgery-Maxillofacial", 
                "Surgery-Neuro", 
                "Surgery-Plastic", 
                "Surgery-PlasticwithinHeadandNeck", 
                "Surgery-Thoracic", 
                "Surgery-Vascular", 
                "SurgicalSpecialty"),
 "Pediatrics" = c("Pediatrics", 
                  "Pediatrics-CriticalCare", 
                  "Pediatrics-EmergencyMedicine", 
                  "Pediatrics-Endocrinology", 
                  "Surgery-Pediatric", 
                  "Pediatrics-Hematology-Oncology", 
                  "Pediatrics-Neurology", 
                  "Pediatrics-Pulmonology", 
                  "Pediatrics-InfectiousDiseases",
                  "Cardiology-Pediatric",
                  "Pediatrics-AllergyandImmunology", 
                  "Anesthesiology-Pediatric"),
 "Cardiology" = "Cardiology",
 "Other" = c("Dermatology", 
                           "Hematology", 
                           "Hematology/Oncology",
                           "InfectiousDiseases", 
                           "Nephrology", 
                           "Neurology", 
                           "Ophthalmology", 
                           "Osteopath",
                           "Orthopedics",
                           "Orthopedics-Reconstructive", 
                           "Otolaryngology", 
                           "Perinatology", 
                           "Psychiatry",
                           "Psychiatry-Addictive", 
                           "Psychiatry-Child/Adolescent", 
                           "Pulmonology", 
                           "Rheumatology", 
                           "Urology", 
                           "AllergyandImmunology",
                          "Anesthesiology", 
                          "Endocrinology-Metabolism",
                         "Neurophysiology",
                         "Dentistry",  
                         "Endocrinology",  
                         "Gynecology", 
                         "Gastroenterology",
                          "Obsterics&Gynecology-GynecologicOnco",
                         "DCPTEAM",
                         "Obstetrics", 
                         "ObstetricsandGynecology", 
                         "Oncology",
                         "OutreachServices", 
                         "Pathology",
                         "PhysicalMedicineandRehabilitation",
                         "Podiatry", 
                         "Proctology", 
                         "Psychology", 
                         "Radiologist",
                         "Radiology", 
                         "Speech", 
                         "SportsMedicine"))

# Create specialty 
df <- df %>%
  mutate(specialty = case_when(
    medical_specialty %in% categories[["Internal_Medicine"]] ~ "Internal_Medicine",
    medical_specialty %in% categories[["Surgery"]] ~ "Surgery",
    medical_specialty %in% categories[["Family/GeneralPractice"]] ~ "Family/GeneralPractice",
    medical_specialty %in% categories[["Emergency/Trauma"]] ~ "Emergency/Trauma",
    medical_specialty %in% categories[["Missing"]] ~ "Missing",
    medical_specialty %in% categories[["Cardiology"]] ~ "Cardiology",
    medical_specialty %in% categories[["Pediatrics"]] ~ "Pediatrics",
    medical_specialty %in% categories[["Other"]] ~ "Other",
    TRUE ~ "Other_Specialties"
  ))

# Check the frequency table of specialty
cat("Frequency table of specialty:\n")
print(table(df$specialty))

# Number of unique specialties in the data
cat("\nNumber of unique specialties in the data:\n")
print(length(unique(df_copy$medical_specialty)))


```

## Update age

-   Visualized age distribution, examined its initial frequency
    distribution, transformed age into numeric categories using midpoint
    values, verified the new distribution, filtered out ages 0-10 then
    condensed age categories into three groups and checked their counts.

```{r}

# Create a bar plot for the race variable with custom colors
ggplot(df, aes(x = age, fill = age)) +
  geom_bar() +
  labs(title = "Bar plot of Age",
       x = "Age", y = "Frequency") +
  scale_fill_manual(values = custom_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) # Set custom bar colors

# table of counts
#table(df$age)

# make it numeric 
df <- df %>%
  mutate(age_2 = case_when(
    age %in% c("[0-10)") ~ "5",
    age %in% c("[10-20)") ~ "15", 
    age %in% c("[20-30)") ~ "25",
    age %in% c("[30-40)") ~ "35",
    age %in% c("[40-50)") ~ "45",
    age %in% c("[50-60)") ~ "55",
    age %in% c("[60-70)") ~ "65",
    age %in% c("[70-80)") ~ "75",
    age %in% c("[80-90)") ~ "85",
    age %in% c("[90-100)") ~ "95",
    TRUE ~ age
  ))

#table(df$age_2)


# Filtering out records with ages between 0 and 10
df <- subset(df, !(age %in% c("[0-10)")))
#table(df$age)

# condense categories
df <- df %>%
  mutate(age = case_when(
    age %in% c("[0-10)", "[10-20)", "[20-30)") ~ "0_to_30",
    age %in% c("[30-40)", "[40-50)", "[50-60)") ~ "30_to_60",
   TRUE ~ "60_and_up"
  ))

# Check the counts for each age group

table(df$age)

```

## Update race

-   Modified race by categorizing specific races into broader groups for
    analysis, assigned "missing" to records with "?" race, and grouped
    Asian, Hispanic, and Other races into a unified "Other" category.

```{r}

df <- df %>%
  mutate(race = case_when(
    race %in% c("?") ~ "Missing",
    race %in% c("Asian", "Hispanic", "Other") ~ "Other",
    race %in% c("AfricanAmerican") ~ "AfricanAmerican",
    race %in% c("Caucasian") ~ "Caucasian",
    
  ))

# Check the counts for each race group
table(df$race)

```

## Update Primary, Secondary, Tertiary diagnosis

-   Created variables primary_diagnosis, secondary_diagnosis, and
    tertiary_diagnosis using mutate() and categorized them based on
    diagnosis codes from UCI ML webpage documentation, then verified
    distributions with frequency tables.

```{r}
# icd-9 codes that indicate uncontrolled diabetes
uncntrl_codes <- c("250.62", "250.63", "250.32", "250.33",
                                   "250.42", "250.43",  "250.52", "250.53",
                                   "250.22","250.23",  "250.12", 
                                   "250.13","250.02", "250.03", "250.92",
                                   "250.93", "250.82", "250.83", "250.72",
                                   "250.73")
# icd-9 codes that indicate controlled diabetes
cntrl_codes<- c("250.01", "250.91", "250.81", "250.71",  "250.61", "250.51",  "250.41", "250.31", "250.21",  "250.11")

# icd-9 codes that indicate unspecified diabetes              
diabetes_unspec_codes <- c("250", "250.9", "250.8", "250.6", "250.4", "250.7", "250.5", "250.3", "250.2", "250.1")

# function to categorize ICD-9 codes
df <- mutate(df,
             primary_diagnosis = case_when(
               diag_1 %in% c(390:459, 785) ~ "circulatory",
               diag_1 %in% c(460:519, 786) ~ "respiratory",
               diag_1 %in% c(520:579, 787) ~ "digestive",
               diag_1 %in% uncntrl_codes ~ 
                 "diabetes uncntrl",
               diag_1 %in% cntrl_codes ~ 
                 "diabetes cntrl",
               diag_1 %in% diabetes_unspec_codes ~ 
                 "diabetes unspec",
               diag_1 %in% c(800:999) ~ "injury",
               diag_1 %in% c(710:739) ~ "musculoskeletal",
               diag_1 %in% c(580:629, 788) ~ "genitourinary",
               diag_1 %in% c(140:239) ~ "neoplasms",
               diag_1 %in% c(780, 781, 783, 784, 789, 790:799) ~ 
                 "other symp",
               diag_1 %in% c(240:249, 251:279) ~ 
                 "endocrine, nuritional/metabolic",
               diag_1 %in% c(680:709, 782) ~
                 "skin and subcutaneous tissue",
               diag_1 %in% c(1:139) ~ 
                 "infectious and parasitic",
               diag_1 %in% c(740:759) ~ 
                 "congenital anamolies",
               diag_1 %in% c(290:319) ~
                 "Mental disorders",
               diag_1 %in% c(280:289) ~ 
                 "blood disorders",
               diag_1 %in% c(320:359) ~ 
                 "nervous system",
               diag_1 %in% c(630:679) ~ 
                 "pregnancy complications",
               diag_1 %in% c(360:389) ~ 
                 "sense organs",
                grepl("V", diag_1) ~ 
                 "external causes",
               grepl("E", diag_1) ~ 
                 "external causes",
               grepl("?", diag_1) ~ 
                 "other symp",
               TRUE ~ as.character(diag_1)
             ))

table(df$primary_diagnosis)
```

```{r}

# categorize diag_2
df <- mutate(df,
             secondary_diagnosis = case_when(
               diag_2 %in% c(390:459, 785) ~ 
                 "circulatory",
               diag_2 %in% c(460:519, 786) ~ 
                 "respiratory",
               diag_2 %in% c(520:579, 787) ~ 
                 "digestive",
               diag_2 %in% uncntrl_codes ~
                 "diabetes uncntrl",
               diag_2 %in% cntrl_codes ~ 
                 "diabetes cntrl",
               diag_2 %in% diabetes_unspec_codes ~ 
                 "diabetes unspec",
               diag_2 %in% c(800:999) ~ 
                 "injury",
               diag_2 %in% c(710:739) ~ 
                 "musculoskeletal",
               diag_2 %in% c(580:629, 788) ~ 
                 "genitourinary",
               diag_2 %in% c(140:239) ~ 
                 "neoplasms",
               diag_2 %in% c(780, 781, 783, 784, 789, 790:799) ~ 
                 "other symp",
               diag_2 %in% c(240:249, 251:279) ~ 
                 "endocrine, nuritional/metabolic",
               diag_2 %in% c(680:709, 782) ~ 
                 "skin and subcutaneous tissue",
               diag_2 %in% c(1:139) ~ 
                 "infectious and parasitic",
               diag_2 %in% c(740:759) ~
                 "congenital anamolies",
               diag_2 %in% c(290:319) ~ 
                 "Mental disorders",
               diag_2 %in% c(280:289) ~ 
                 "blood disorders",
               diag_2 %in% c(320:359) ~ 
                 "nervous system",
               diag_2 %in% c(630:679) ~
                 "pregnancy complications",
               diag_2 %in% c(360:389) ~ 
                 "sense organs",
                grepl("V", diag_2) ~
                 "external causes",
               grepl("E", diag_2) ~ 
                 "external causes",
               grepl("?", diag_2) ~ 
                 "other symp",
               TRUE ~ as.character(diag_2)
             ))

table(df$secondary_diagnosis)

# categorize diag_3
df <- mutate(df,
             tertiary_diagnosis = case_when(
               diag_3 %in% c(390:459, 785) ~ 
                 "circulatory",
               diag_3 %in% c(460:519, 786) ~ 
                 "respiratory",
               diag_3 %in% c(520:579, 787) ~ 
                 "digestive",
               diag_3 %in% uncntrl_codes ~
                 "diabetes uncntrl",
               diag_3 %in% cntrl_codes ~ 
                 "diabetes cntrl",
               diag_3 %in% diabetes_unspec_codes ~ 
                 "diabetes unspec",
               diag_3 %in% c(800:999) ~ 
                 "injury",
               diag_3 %in% c(710:739) ~ 
                 "musculoskeletal",
               diag_3 %in% c(580:629, 788) ~ 
                 "genitourinary",
               diag_3 %in% c(140:239) ~ 
                 "neoplasms",
               diag_3 %in% c(780, 781, 783, 784, 789, 790:799) ~ 
                 "other symp",
               diag_3 %in% c(240:249, 251:279) ~ 
                 "endocrine, nuritional/metabolic",
               diag_3 %in% c(680:709, 782) ~ 
                 "skin and subcutaneous tissue",
               diag_3 %in% c(1:139) ~ 
                 "infectious and parasitic",
               diag_3 %in% c(740:759) ~
                 "congenital anamolies",
               diag_3 %in% c(290:319) ~ 
                 "Mental disorders",
               diag_3 %in% c(280:289) ~ 
                 "blood disorders",
               diag_3 %in% c(320:359) ~ 
                 "nervous system",
               diag_3 %in% c(630:679) ~
                 "pregnancy complications",
               diag_3 %in% c(360:389) ~ 
                 "sense organs",
                grepl("V", diag_3) ~
                 "external causes",
               grepl("E", diag_3) ~ 
                 "external causes",
               grepl("?", diag_3) ~ 
                 "other symp",
               TRUE ~ as.character(diag_3)
             ))

table(df$tertiary_diagnosis)
# set as factors
df$primary_diagnosis<- as.factor(df$primary_diagnosis)
df$secondary_diagnosis<- as.factor(df$secondary_diagnosis)
df$tertiary_diagnosis<- as.factor(df$tertiary_diagnosis)

```

```{r}

# Diagnosis variables to iterate over
diagnosis_vars <- c("diag_1", "diag_2", "diag_3")

# Loop through each diagnosis variable
for (var in diagnosis_vars) {
  cat("There are", length(unique(df[[var]])), "unique diagnoses for", var, "\n")
}

```

## Update Discharge Disposition

-   Transformed \`discharge_disposition_id\` to assign meaningful
    categories (e.g., home, short_term_hospital, SNF, ICF) and created a
    binary variable \`discharge\` distinguishing between Home and Other
    dispositions, followed by examining the updated distribution with a
    frequency table.

```{r}
df <- df %>%
  mutate(discharge_disposition_id = case_when(
    discharge_disposition_id == 1 ~ "home",
    discharge_disposition_id == 2 ~ "short_term_hospital",
    discharge_disposition_id == 3 ~ "SNF",
    discharge_disposition_id == 4 ~ "ICF",
    discharge_disposition_id == 5 ~ "transfer_inpatient",
    discharge_disposition_id == 7 ~ "left_AMA",
    discharge_disposition_id == 22 ~ "transfer_rehab",
    discharge_disposition_id == 23 ~ "transfer_long_term",
    discharge_disposition_id == 28 ~ "transfer_psych",
    discharge_disposition_id %in% c(6, 8) ~ 
      "home_w_health_services",
    discharge_disposition_id %in% c(12,16, 17 ) ~ 
      "transfer_outpatient",
    
    discharge_disposition_id %in% c(24, 27, 29) ~ 
      "transfer_other_external",
    discharge_disposition_id %in% c(13, 14) ~ 
      "hospice",
    discharge_disposition_id %in% c(11, 19, 20, 21) ~ 
      "expired",
    discharge_disposition_id %in% c(25, 26, 18) ~ 
      "unknown",
    discharge_disposition_id %in% c(9, 10, 15) ~ 
      "Other",
    discharge_disposition_id == 7 ~ "Emergency" ))

# see categories
table(df$discharge_disposition_id)

# total counts of each unique category
length(unique(df_copy$discharge_disposition_id))


# creating discharge - binary variable
df <- df %>%
  mutate(discharge = ifelse(discharge_disposition_id == "home", "Home", "Other"))

# Check the first few rows to verify
head(df)
table(df$discharge)


```

## Update Gender

-   Examined gender distribution initially, created `df_subset`
    excluding Unknown/Invalid values, replaced these with NA, imputed
    random genders for missing values, checked updated distribution, and
    conducted a two-proportion test to assess male proportion
    differences between groups.

```{r}

# original distribution of gender in df
table(df$gender)

# make subset without missing values
df$gender_no_na<- df$gender
df_subset <- df[df$gender %in% c("Male", "Female"), ]

table(df_subset$gender)


        # Female            Male      Unknown/Invalid 
        #  54708           47055               3 

# Replace "Unknown/Invalid" with NA
df$gender[df$gender == "Unknown/Invalid"] <- NA

# Generate random indices for missing gender values
missing_indices <- which(is.na(df$gender))

# Get the number of missing values
num_missing <- length(missing_indices) # 3

set.seed(123)
# Generate random gender values (assuming binary: "Male" and "Female")
random_gender <- sample(c("Male", "Female"), num_missing, replace = TRUE)

# Assign random gender values to missing indices
df$gender[missing_indices] <- random_gender

# Check the distribution of the gender variable before and after imputation
table(df$gender)
df$gender <- droplevels(df$gender)
table(df$gender)
table(df$gender_no_na)


# Define the counts for males and females in each group
group1_male <- 46980 
group1_female <- 54625
group2_male <- 46977
group2_female <- 54625

# Conduct test of two proportions
prop_test <- prop.test(c(group1_male, group2_male), c(group1_male + group1_female, group2_male + group2_female))

# Print results
print(prop_test)


```

The two-proportion test yielded a test statistic of 1.9666e-27 with 1
degree of freedom, resulting in a p-value of 1, indicating insufficient
evidence to reject the null hypothesis of no difference in male
proportions between the groups; sample estimates show approximately
0.4623690 for group 1 and 0.4623629 for group 2.

## Admission Source

-   All instances related to pediatric admission sources (IDs 13, 14,
    and 11) were removed from the dataset to prevent biased data.

-   Assigned labels to admission type IDs:

    -   IDs 1 and 7 as Emergency_or_trauma,

    -   ID 2 as Urgent, ID 3 as Elective,

    -   ID 4 as Newborn, and

    -   IDs 5, 6, and 8 as Missing for handling missing, NA, and Null
        values.

    -   All other values were labeled as *Other*.

-   Checked distribution with `table()`, counted unique IDs in
    `df_copy`, verified updated admission source ID distribution with
    `table()`, and compared unique IDs in `df_copy`.

```{r}

# counts of admission source ID
table(df$admission_source_id)

# remove all pediatric instances
df <- df %>%
  filter(admission_source_id != 13 & admission_source_id != 14 & 
           admission_source_id != 11)


# Replace values based on conditions
df$admission_source_id <- ifelse(df$admission_source_id == c(7, 25), "ER",
                           ifelse(df$admission_source_id %in% c(1, 2, 3), "refferal",
                           ifelse(df$admission_source_id %in% c(4, 5, 10, 6, 22), "transfer",
                           ifelse(df$admission_source_id %in% c(15, 17, 20, 8, 9), "Missing", "Other"))))

table(df$admission_source_id)

df$admission_source_id<- as.factor(df$admission_source_id)

length(unique(df_copy$admission_source_id))



```

## Admission Type ID

-   The admission type IDs were then transformed based on certain
    conditions using the mutate() function in combination with
    case_when():

    -   Assign labels to admission type IDs:
    -   IDs 1 and 7 as Emergency_or_trauma
    -   ID 2 as Urgent
    -   ID 3 as Elective
    -   ID 4 as Newborn
        IDs 5, 6, and 8 combined and labeled as Missing for handling
        missing, NA, and Null values
        Any other value labeled as Other

```{r}
# counts of each category of admission type ID
table(df$admission_type_id)

# function to categorize admission type ID
df <- df %>%
  mutate(admission_type_id = case_when(
    admission_type_id == 1 | admission_type_id == 7 ~ "Emergency_or_trauma",
    admission_type_id == 2 ~ "Urgent",
    admission_type_id == 3 ~ "Elective",
    admission_type_id == 4 ~ "Newborn",
    admission_type_id %in% c(5, 6, 8) ~ "Missing",  # Combine missing, NA, and Null into "Missing"
    TRUE ~ "Other"  # Label any other value as "Other"
  ))



# Check the first few rows to verify
table(df$admission_type_id)


# number of unique instances in original data
length(unique(df_copy$admission_type_id))

```

## Medication Type

-   Created `medication_type` to categorize patient medication into
    insulin, other oral medications, or both.

```{r}

# Define lists of oral and injectable medications
oral_medications <- c("metformin", "repaglinide", 
                      "nateglinide", "chlorpropamide", 
                      "glimepiride", "acetohexamide", 
                      "glipizide", "glyburide", 
                      "tolbutamide", "pioglitazone", 
                      "rosiglitazone", "acarbose",  
                      "miglitol", "troglitazone", 
                      "tolazamide", "glyburide.metformin",  
                      "glipizide.metformin", 
                      "glimepiride.pioglitazone", 
                      "metformin.rosiglitazone", 
                      "metformin.pioglitazone")

injectable_medication <- "insulin"

# Create a new variable indicating medication type
df$medication_type <- "None"  # Initialize with None

# Check for oral medications
df$medication_type <- 
  ifelse(rowSums(df[oral_medications] == "Steady" |
                  df[oral_medications] == "Down" |
                  df[oral_medications] == "Up") > 0,"Oral",
         df$medication_type)

# Check for injectable medication
df$medication_type <- ifelse(df$insulin == "Steady" | 
                                  df$insulin == "Down" | 
                                  df$insulin == "Up",
                      ifelse(df$medication_type ==
                               "Oral", "Both","Injectable"),
        df$medication_type)

```

## ICD-9 label

-   Created `icd9_label` and `icd9_label2` from `diag_1` and `diag_2` to
    categorize ICD-9 diagnosis codes into broader categories.

```{r}
df <- mutate(df,
             diag_1_clean = case_when(
               
               # top columns
               diag_1 %in% c(428:428.99) ~ "heart failure", 
               diag_1 %in% c(414) ~ "aortic aneurysm",
               diag_1 %in% c(786) ~ "chest pain",
               diag_1 %in% c(410) ~ "heart failure",
               diag_1 %in% c(486) ~ "pneumonia",
               diag_1 %in% c(426:427) ~ "Conduction disorders and cardiac dysrhythmias",
               diag_1 %in% c(491) ~ "Chronic bronchitis",
               diag_1 %in% c(715) ~ "Osteoarthrosis",
               #diag_1 %in% c(682) ~ "cellulitis_ and_abscess",
               diag_1 %in% c(434) ~ "occlusion_of_cerebral_arteries",
               diag_1 %in% c(780) ~ "General_symptoms",
               diag_1 %in% c(996) ~ "procedure_complications",
               diag_1 %in% c(276) ~ "Disorders_of_fluid_electrolyte ",
               diag_1 %in% c(38) ~ "Incision_of_Vessels",
               diag_1 %in% c(599) ~ "urethra_and_urinary_tract",
               diag_1 %in% c(584) ~ "in-hospital_acute_kidney_failure",
               diag_1 %in% c(401:402.9) ~ "hypertension",
               diag_1 %in% c(586) ~ "renal disease",
               diag_1 %in% c("250.62", "250.63", "250.32", "250.33",
                                   "250.42", "250.43",  "250.52", "250.53",
                                   "250.22","250.23",  "250.12", 
                                   "250.13","250.02", "250.03", "250.92",
                                   "250.93", "250.82", "250.83", "250.72",
                                   "250.73") ~ "Uncontrolled Diabetes",
               diag_1 %in% c( "250.01", "250.91", "250.81", 
                             "250.71",  "250.61", "250.51",  "250.41", "250.31",
                             "250.21",  "250.11") ~ "Controlled Diabetes",
               diag_1 %in% c("250.9", "250.8", "250.6", "250.4", "250.7", "250.5",
                            "250.3", "250.2", "250.1") ~ "diabetes unspecified",
              substr(diag_1, 1, 1) == "V" ~ "vaccination",
               TRUE ~ diag_1
             ))

diag1_table <- table(df$diag_1_clean)
diag1_table <- sort(diag1_table, decreasing = TRUE)


# Define a function to categorize ICD-9 codes
categorize_icd9 <- function(diag_1_clean) {
  case_when(
    diag_1_clean %in% c(1:139) ~ "Infectious and Parasitic Diseases",
    diag_1_clean %in% c(140:239) ~ "Neoplasms",
    diag_1_clean %in% c(240:279) ~ "Endocrine, Nutritional, and Metabolic Diseases",
    diag_1_clean %in% c(280:289) ~ "Diseases of the Blood and Blood-Forming Organs",
    diag_1_clean %in% c(290:319) ~ "Mental Disorders",
    diag_1_clean %in% c(320:389) ~ "Diseases of the Nervous System and Sense Organs",
    # specified bc its top 2 most prominent 
    diag_1_clean %in% c(410:414) ~ "Acute Myocardial Infarction",
    
    diag_1_clean %in% c(390:459) ~ "Diseases of the Circulatory System",
    diag_1_clean %in% c(460:519) ~ "Diseases of the Respiratory System",
    diag_1_clean %in% c(520:579) ~ "Diseases of the Digestive System",
    diag_1_clean %in% c(580:629) ~ "Diseases of the Genitourinary System",
    diag_1_clean %in% c(630:679) ~ "Complications of Pregnancy, Childbirth, and the Puerperium",
    diag_1_clean %in% c(680:709) ~ "Diseases of the Skin and Subcutaneous Tissue",
    diag_1_clean %in% c(710:739) ~ "Diseases of the Musculoskeletal System and Connective Tissue",
    diag_1_clean %in% c(740:759) ~ "Congenital Anomalies",
    diag_1_clean %in% c(760:779) ~ "Certain Conditions Originating in the Perinatal Period",
    diag_1_clean %in% c(780:799) ~ "Ill-Defined Conditions",
    diag_1_clean %in% c(800:999, "E909") ~ "Injury and Poisoning",
    TRUE ~ as.character(diag_1_clean)  # Return original code for unmatched cases
  )
}

# Apply the categorize_icd9 function to create a new column icd9_label
df <- df %>%
  mutate(
    icd9_label = categorize_icd9(diag_1_clean)
  )

# Convert icd9_label to a factor
df$icd9_label <- as.factor(df$icd9_label)


# assess counts
table(df$icd9_label)

```

```{r}


```

ICD-9 label transformation for secondary diagnosis

```{r}
df <- mutate(df,
             diag_2_clean = case_when(
               
               # top columns
               diag_2 %in% c(428) ~ "heart failure", # made these the same
               diag_2 %in% c(414) ~ "heart failure",
               diag_2 %in% c(786) ~ "respiratory_chest",
               diag_2 %in% c(410) ~ "heart failure",
               diag_2 %in% c(486) ~ "pneumonia",
               diag_2 %in% c(427) ~ "Cardiac dysrhythmias",
               diag_2 %in% c(491) ~ "Chronic bronchitis",
               diag_2 %in% c(715) ~ "Osteoarthrosis",
               diag_2 %in% c(682) ~ "cellulitis_ and_abscess",
               diag_2 %in% c(434) ~ "occlusion_of_cerebral_arteries",
               diag_2 %in% c("250.62", "250.63", "250.32", "250.33",
                                   "250.42", "250.43",  "250.52", "250.53",
                                   "250.22","250.23",  "250.12", 
                                   "250.13","250.02", "250.03", "250.92",
                                   "250.93", "250.82", "250.83", "250.72",
                                   "250.73") ~ "Uncontrolled Diabetes",
               
               diag_2 %in% c("250.9", "250.01", "250.91", "250.8", "250.81", 
                                   "250.7", "250.71", "250.6", "250.61",
                                   "250.5", "250.51", "250.4", "250.41",
                                   "250.3", "250.31", "250.2", "250.21", 
                                   "250.1", "250.11") ~ "Controlled Diabetes",
               
              substr(diag_2, 1, 1) == "V" ~ "vaccination",
              substr(diag_2, 1, 1) == "E" ~ "Injury and Poisoning",
               TRUE ~ diag_2
             ))

diag2_table <- table(df$diag_2_clean)
diag2_table <- sort(diag2_table, decreasing = TRUE)
#table(df$diag_1_clean)



categorize_icd9 <- function(diag_2_clean) {
  case_when(
    diag_2_clean %in% c(1:139) ~ "Infectious and Parasitic Diseases",
    diag_2_clean %in% c(140:239) ~ "Neoplasms",
    diag_2_clean %in% c(240:279) ~ "Endocrine, Nutritional, and Metabolic Diseases",
    diag_2_clean %in% c(280:289) ~ "Diseases of the Blood and Blood-Forming Organs",
    diag_2_clean %in% c(290:319) ~ "Mental Disorders",
    diag_2_clean %in% c(320:389) ~ "Diseases of the Nervous System and Sense Organs",
    # specified bc its top 2 most prominent 
    diag_2_clean %in% c(410:414) ~ "Acute Myocardial Infarction",
    
    diag_2_clean %in% c(390:459) ~ "Diseases of the Circulatory System",
    diag_2_clean %in% c(460:519) ~ "Diseases of the Respiratory System",
    diag_2_clean %in% c(520:579) ~ "Diseases of the Digestive System",
    diag_2_clean %in% c(580:629) ~ "Diseases of the Genitourinary System",
    diag_2_clean %in% c(630:679) ~ "Complications of Pregnancy, Childbirth, and the Puerperium",
    diag_2_clean %in% c(680:709) ~ "Diseases of the Skin and Subcutaneous Tissue",
    diag_2_clean %in% c(710:739) ~ "Diseases of the Musculoskeletal System and Connective Tissue",
    diag_2_clean %in% c(740:759) ~ "Congenital Anomalies",
    diag_2_clean %in% c(760:779) ~ "Certain Conditions Originating in the Perinatal Period",
    diag_2_clean %in% c(780:799) ~ "Ill-Defined Conditions",
    diag_2_clean %in% c(800:999, "E909") ~ "Injury and Poisoning",
    TRUE ~ as.character(diag_2_clean)  # Return original code for unmatched cases
  )
}

# Apply the categorize_icd9 function to create a new column icd9_label
df <- df %>%
  mutate(
    icd9_label2 = categorize_icd9(diag_2_clean)
  )

# Convert icd9_label to a factor
df$icd9_label2 <- as.factor(df$icd9_label2)


# assess counts
table(df$icd9_label2)


```

Fixing data types before saving data frame.

```{r}

# Set all numeric columns to class "numeric"
numeric_cols <- sapply(df, is.numeric)
df[numeric_cols] <- lapply(df[numeric_cols], as.numeric)

# Set all character columns to class "factor"
character_cols <- sapply(df, is.character)
df[character_cols] <- lapply(df[character_cols], as.factor)

# save dataset
write.csv(df, "df")

```

# Model Prep

## Retain single patient encounter

-   A copy of the original dataframe `df` is created as `dfC`, which is
    then sorted in ascending order based on `patient_nbr` and
    `encounter_id`. Duplicate rows based on `patient_nbr` are removed,
    retaining the first occurrence of each unique `patient_nbr` while
    preserving all columns using `distinct()` with `.keep_all = TRUE`
    from the dplyr package.

```{r}

# Create a copy of the original dataframe
dfC <- df[,]

# Arrange the dataframe by patient_nbr and encounter_id
dfC <- dfC %>%
  arrange(patient_nbr, encounter_id)

# Remove duplicate rows based on patient_nbr, keeping only the first occurrence
dfC <- dfC %>%
  distinct(patient_nbr, .keep_all = TRUE)


```

## Remove discharge dispositions *death* and *hospice*

```{r}

# Define the values to be removed
values_to_remove <- c("expired", "hospice")

# Remove records with specified values for discharge_disposition_id
dfC <- dfC[!(dfC$discharge_disposition_id %in% values_to_remove), ]


```

## Remove newborn-related encounters

-   Defined `values_to_remove` for "Newborn" encounters, filtered `df`
    using Boolean indexing on `admission_type_id`, displayed the table
    to confirm removal, converted `admission_type_id` to factor and
    dropped extra levels for consistency.

    Similarly, defined `values_to_remove` for "Pediatrics", filtered
    `df` using Boolean indexing on `specialty`, displayed the table to
    confirm removal, and converted `specialty` to factor while dropping
    extra levels for consistency.

```{r}

# Define the value to be removed
values_to_remove <- c("Newborn")

# Remove records with specified values for discharge_disposition_id
dfC <- dfC[!(dfC$admission_type_id %in% values_to_remove), ]

table(dfC$admission_type_id)

# remove extra category in admission type id
dfC$admission_type_id<- as.factor(dfC$admission_type_id)
dfC$admission_type_id <- droplevels(dfC$admission_type_id)

# Define the value to be removed
values_to_remove <- c("Pediatrics")

# Remove records with specified values 
dfC <- dfC[!(dfC$specialty %in% values_to_remove), ]

# Check the table after removal
table(dfC$specialty)

# Remove Pediatrics as a category from the specialty column
dfC$specialty<- as.factor(dfC$specialty)
dfC$specialty <- droplevels(dfC$specialty)

# Check the table after removal
table(dfC$specialty)

```

# Data Transformations

## Comorbidity scores

-   Reformatted `dfC` by melting it into long format (`df_long`) using
    `encounter_id`, identifying and removing rows with missing
    diagnostic codes, then applied a comorbidity function using patient
    identifiers and Charlson codes, ensuring alignment between patient
    numbers and resulting comorbidity scores.

```{r}
# Melt the dataframe to long format, keeping encounter_id as identifier
df_long <- reshape(dfC, direction = "long", varying = list(c("diag_1", "diag_2", "diag_3")), v.names = "code", idvar = "patient_nbr", times = c(1, 2, 3), timevar = "diagnosis_order")

df_long$code<- as.numeric(df_long$code)

# Identify rows with missing codes
df_long$missing_code <- df_long$code == "?"
table(df_long$missing_code)
# remove var
df_long$missing_code<-NULL

# Print the first 15 rows of the transformed dataframe
print(head(df_long, n = 15), row.names = FALSE)


# Now use filtered data frame with comorbidity function

charlson <- comorbidity(x = df_long, id = "patient_nbr", code = "code", map = "charlson_icd9_quan", assign0 = TRUE)


# Print the structure of dfC
str(charlson)
#table(dfC$diag_1)

length(unique(df_long$patient_nbr)) == nrow(charlson) # check for TRUE
```

-   Computed Charlson Scores, applying weights for comorbidity severity,
    previewed structure, summarized and visualized with histograms
    showing distribution of scores and readmission status.

```{r}

# get scores
scores <- score(charlson, weights = "quan", assign0 = FALSE)
length(scores) == nrow(charlson) # TRUE
table(scores)

# bind scores
dfC <- cbind(dfC, scores)

# Print the structure of the updated dataframe
str(dfC)
summary(dfC$scores)

# histogram of charlson scores
ggplot(dfC, aes(x = scores)) +
  geom_histogram(fill = custom_colors[2], color = "black", bins = 9) +
  labs(title = "Distribution of Charlson Scores",
       x = "Charlson Scores", y = "Frequency") +
  custom_theme


# histogram of charlson scores against readmitted
ggplot(data = dfC, aes(x = scores, fill = factor(readmitted))) + 
  geom_bar(position = "fill") + 
  scale_x_discrete("Number of Charlson Scores") + 
  scale_y_continuous("Frequency") + 
  guides(fill = guide_legend(title = "Readmitted")) + 
  scale_fill_manual(values = c("#bfb5f9", "#5236ab")) + 
  labs(title = "Normalized Distribution of Number of Charlson scores by Readmission")

```

-   Compute Elixhauser Scores by applying the comorbidity function,
    setting `patient_nbr` as the identifier and `code` using the
    Elixhauser comorbidity map, verify the structure and alignment of
    patient numbers with `elihxauser`, append scores to `dfC`, and
    summarize Elixhauser scores.

```{r}
# use the filtered data frame with comorbidity function
elihxauser <- comorbidity(x = df_long, id = "patient_nbr", code = "code", map = "elixhauser_icd9_quan", assign0 = FALSE)


# Print the structure of dfC
str(elihxauser)

length(unique(df_long$patient_nbr)) == nrow(elihxauser) # check for TRUE

# get scores
Escores <- score(elihxauser, weights = "vw", assign0 = FALSE)
length(Escores) == nrow(elihxauser) # check for TRUE
table(Escores)

# bind to dfC
dfC <- cbind(dfC, Escores)
dfC$Escores<- as.numeric(dfC$Escores)
summary(dfC$Escores)
```

-   Visualize Elixhauser Scores with histograms: plot the distribution
    of scores in dfC and compare scores against readmission status,
    displaying the normalized distribution.

```{r}

# histogram of Elixhauser scores
ggplot(dfC, aes(x = Escores)) +
  geom_histogram(fill = custom_colors[2], color = "black", bins = 37) +
  labs(title = "Histogram of Elixhauser Scores",
       x = "Elixhauser Scores", y = "Frequency") +
  custom_theme

# normalized histogram of Elixhauser scores
ggplot(data = dfC, aes(x = Escores, fill = factor(readmitted))) + 
  geom_bar(position = "fill") + 
  scale_x_discrete("Number of Elixhauser Scores") + 
  scale_y_continuous("Frequency") + 
  guides(fill = guide_legend(title = "Readmitted")) + 
  scale_fill_manual(values = c("#bfb5f9", "#5236ab")) + 
  labs(title = "Normalized Distribution of Number of Elixhauser scores by Readmission")

```

-   Examine EScores with subsets, Generate new_df for records with a
    specific icd9_label, visualize readmitted_2 with barcharts for
    new_df and dfC, create contingency tables for readmitted_2 in both
    datasets, compute column proportions using prop.table, and display
    these proportions for both datasets.

```{r}

```

```{r}

#Escores<- dfC$Escores
# Elixhauser scores
hist(dfC$Escores)


# standardized Elixhauser scores
Emean_score <- mean(dfC$Escores)
Esd_score <- sd(dfC$Escores)
dfC$standardized_Escores <- (dfC$Escores - Emean_score) / Esd_score
hist(dfC$standardized_Escores)


# log Elixhauser scores # #Escores +20
dfC$log_Escores <- log(dfC$Escores+20)
hist(dfC$log_Escores)

# square root transformation
dfC$sqrt_Escores <- sqrt(dfC$Escores)
hist(dfC$sqrt_Escores)

```

```{r}
# Charlson scores
hist(dfC$scores)

# standardized Charlson scores
mean_score <- mean(dfC$scores)
sd_score <- sd(dfC$scores)
dfC$standardized_scores <- (dfC$scores - mean_score) / sd_score
hist(dfC$standardized_scores)

# log Charlson scores
dfC$log_scores <- log(dfC$scores +1)
hist(dfC$log_scores)


# square root transformation
dfC$sqrt_scores <- sqrt(dfC$scores)
hist(dfC$sqrt_scores)



```

## Time in hospital

```{r}
# time in hospital
hist(dfC$time_in_hospital)

# log transformation
dfC$log_time_hosp <- log(dfC$time_in_hospital + 1)
hist(dfC$log_time_hosp)

# square root transformation
dfC$sqrt_time_hosp <- sqrt(dfC$time_in_hospital)
hist(dfC$sqrt_time_hosp)



```

## Number of lab procedures

```{r}

# log transformation
dfC$log_num_lab <- log(dfC$num_lab_procedures + 1)
hist(dfC$log_num_lab)

# square root transformation
dfC$sqrt_num_lab <- sqrt(dfC$num_lab_procedures)
hist(dfC$sqrt_num_lab)

# standardization
mean_lab <- mean(dfC$num_lab_procedures)
sd_lab <- sd(dfC$num_lab_procedures)
dfC$standardized_num_lab <- (dfC$num_lab_procedures - mean_lab) / sd_lab
hist(dfC$standardized_num_lab)



# binary transformation, greater than 40
dfC$num_lab_procedures_binary50 <- ifelse(dfC$num_lab_procedures > 50, 1, 0)

# binary transformation, greater than 40
dfC$num_lab_procedures_binary40 <- ifelse(dfC$num_lab_procedures > 40, 1, 0)

# binary transformation, greater than 20
dfC$num_lab_procedures_binary20 <- ifelse(dfC$num_lab_procedures > 20, 1, 0)

# binary transformation, greater than 1
dfC$num_lab_procedures_binary1 <- ifelse(dfC$num_lab_procedures > 1, 1, 0)



# Box-Cox Transformation

# Find lambda using Box-Cox transformation
boxcox_transform <- function(x) {
  # Try lambda values from -2 to 2
  lambda_seq <- seq(-2, 2, by = 0.1)
  n <- length(x)
  log_likelihood <- numeric(length(lambda_seq))
  
  for (i in seq_along(lambda_seq)) {
    lambda <- lambda_seq[i]
    if (lambda == 0) {
      log_likelihood[i] <- sum(log(x))
    } else {
      log_likelihood[i] <- sum((x^lambda - 1) / lambda - lambda * log(x))
    }
  }
  
  # Find optimal lambda that maximizes log-likelihood
  optimal_lambda <- lambda_seq[which.max(log_likelihood)]
  
  return(optimal_lambda)
}

# Apply Box-Cox transformation
lambda <- boxcox_transform(dfC$num_lab_procedures)

# Perform Box-Cox transformation
if (lambda == 0) {
  dfC$boxcox_num_lab_procedures <- log(dfC$num_lab_procedures)
} else {
  dfC$boxcox_num_lab_procedures <- (dfC$num_lab_procedures^lambda - 1) / lambda
}

hist(dfC$boxcox_num_lab_procedures)


# standardizing box cox transformed var
mean_lab <- mean(dfC$boxcox_num_lab_procedures)
sd_lab <- sd(dfC$boxcox_num_lab_procedures)
dfC$standardized_bc_num_lab <- (dfC$boxcox_num_lab_procedures - mean_lab) / sd_lab
hist(dfC$standardized_bc_num_lab)
```

## Number of Medications

```{r}
# log num_medications
dfC$log_num_med <- log(dfC$num_medications + 1)
hist(dfC$log_num_med)

# square root transformation
dfC$sqrt_num_med <- sqrt(dfC$num_medications)
hist(dfC$sqrt_num_med)

# standardization
mean_lab <- mean(dfC$num_medications)
sd_lab <- sd(dfC$num_medications)
dfC$standardized_num_med <- (dfC$num_medications - mean_lab) / sd_lab
hist(dfC$standardized_num_med)


# using Box-cox function defined in previous chunk

# Apply Box-Cox transformation
lambda <- boxcox_transform(dfC$num_medications)

# Perform Box-Cox transformation
if (lambda == 0) {
  dfC$boxcox_num_meds <- log(dfC$num_medications)
} else {
  dfC$boxcox_num_meds <- (dfC$num_medications^lambda - 1) / lambda
}

hist(dfC$boxcox_num_meds)

```

## Number of Emergency, Outpatient and Inpatient Visits.

```{r}


# log emergency visits
dfC$log_num_emer <- log(dfC$number_emergency +1)
hist(dfC$log_num_emer)

# log outpatient visits
dfC$log_num_outp <- log(dfC$number_outpatient + 1)
hist(dfC$log_num_outp)

# log inpatient visits
dfC$log_num_inpt <- log(dfC$number_inpatient + 1)
hist(dfC$log_num_inpt)


```

```{r}


```

## Preceding visits

```{r}
# Create the new variable by summing the three variables
dfC$preceding_visits <- dfC$number_emergency + dfC$number_outpatient + dfC$number_inpatient

# total preceding visits
#table(dfC$preceding_visits)

# precedicing visits against readmitted
readmission_table <- table(dfC$preceding_visits, dfC$readmitted)
#print(readmission_table)

# proportions of preceding visits
proportions_table <- prop.table(readmission_table, margin = 1)
#print(proportions_table)
```

## Preceding visits (binary)

```{r}
# Create a new binary variable
dfC$preceding_visits_binary <- ifelse(dfC$preceding_visits > 1, 1, 0)

# precedicing visits against readmitted
readmission_table <- table(dfC$preceding_visits_binary, dfC$readmitted)
readmission_table

# Calculate proportions
proportions_table <- prop.table(readmission_table, margin = 1)

# Display the table of proportions
print(proportions_table)
# we cans see that there are more patients readmitted if they had at least one preceding visit in the last year

```

## Preceding visits (weighted)

```{r}

# Create the new variable with weighted visits
dfC$preceding_visits_weighted <- dfC$number_emergency * 5 + dfC$number_inpatient * 3 + dfC$number_outpatient


# total preceding visits
#
# precedicing visits against readmitted
readmission_table <- table(dfC$preceding_visits_weighted, dfC$readmitted)
#print(readmission_table)

# proportions of preceding visits
proportions_table <- prop.table(readmission_table, margin = 1)
#print(proportions_table)

```

## Sensitivity Testing

Split data 80/20 for training/testing, checked test set class
proportions against the dataset, balanced training by oversampling class
1, evaluated logistic regression impacts on predictors, adjusted model
variables, and assessed performance with confusion matrix, ROC curve,
and AUC using the balanced training set.

```{r}

set.seed(123)
# partition the data on 80/20 split
train_indices <- createDataPartition(dfC$readmitted, p = 0.8, list = FALSE)
train_set <- dfC[train_indices, ]
test_set <- dfC[-train_indices, ]

# compare proportions to assess any differences
prop.table(table(test_set$readmitted))
prop.table(table(dfC$readmitted))


#  train balanced set
table(train_set$readmitted)
readmitted_1_indices <- which(train_set$readmitted == 1)
oversampled_indices <- sample(readmitted_1_indices, sum(train_set$readmitted == 0), replace = TRUE)
all_indices <- c(which(train_set$readmitted == 0), oversampled_indices)
train_set_balanced <- train_set[all_indices, ]
table(train_set_balanced$readmitted)



# build model
set.seed(10)
TC <- trainControl( method = "CV", number = 10)
train_set_balanced$readmitted<-as.factor(train_set_balanced$readmitted)


# add or remove variables to assess impact 
model <- train(readmitted ~ 
                 # log_Escores + 
                 # scores + 
                 # Escores +
                 # logEscores +
                 # preceding_visits_weighted +
                 # preceding_visits +
                 # preceding_visits_binary + 
                 gender  + 
                 age  + 
                 race +
                 specialty +
                 discharge +
                 admission_source_id +
                 time_in_hospital   + 
                 num_lab_procedures +
                 num_medications +
                 diabetesMed,
        
               data = train_set_balanced, 
               method = "glm",
               family = binomial,
               trControl = TC)

# model summary
summary(model)

# predictions
testsetpreds.LR <- predict(model, test_set)
table(test_set$readmitted, testsetpreds.LR)

# Calculate confusion matrix
test_set$readmitted<- as.factor(test_set$readmitted)
cm1 <- confusionMatrix(testsetpreds.LR, reference = test_set$readmitted, positive = "1")
print(cm1)

# Calculate ROC curve
roc_curve <- roc(test_set$readmitted, as.numeric(testsetpreds.LR))
plot(roc_curve, main = "ROC Curve for LASSO Model", col = "blue", lwd = 2)
auc_value <- auc(roc_curve)
print(paste("AUC:", auc_value))



```

# Partitioning *readmission*

Filtered records in the dataframe to include only those with "\<30" or
"NO" in the readmitted_2 column, transformed readmitted_2 into binary
format (1 for "\<30", 0 for "NO"), and examined the distribution and
proportions of the binary values.

In comparison with the original data, showcased the distribution and
proportions of the binary readmitted_2 values within the filtered
dataframe dfC, contrasting them with the distributions in the original
dataframe df.

```{r}
# Filter records with only "<30" or "NO" values

table(dfC$readmit)
dfC <- subset(dfC, readmit %in% c("<30", "NO"))

# Revalue
dfC$readmitted_2 <- ifelse(dfC$readmit == "<30", 1, 0)

# distribution
table(dfC$readmitted_2)
prop.table(table(dfC$readmitted_2))

```

Created a balanced training set (train_set_balanced2) by oversampling
the positive records with replacement until both classes were
represented equally.

```{r}

set.seed(123)

train_indices <- createDataPartition(dfC$readmitted_2, p = 0.8, list = FALSE)
train_set2 <- dfC[train_indices, ]
test_set2 <- dfC[-train_indices, ]

# Proportion of classes in the test set
prop.table(table(test_set2$readmitted_2))

# Proportion of classes in the entire dataset
prop.table(table(dfC$readmitted_2))

# Balanced set
table(train_set2$readmitted_2)
readmitted_1_indices <- which(train_set2$readmitted_2 == 1)

oversampled_indices <- sample(readmitted_1_indices, sum(train_set2$readmitted_2 == 0), replace = TRUE)

all_indices <- c(which(train_set2$readmitted_2 == 0), oversampled_indices)
train_set_balanced2 <- train_set2[all_indices, ]
table(train_set_balanced2$readmitted_2)


```

Comparing subsets of \<30 and NO vs \<30\|\>30 &NO

```{r}
set.seed(10)
TC <- trainControl( method = "CV", number = 10)

train_set_balanced2$readmitted_2<-as.factor(train_set_balanced2$readmitted_2)

model <- train(readmitted_2 ~ 
                 log_scores +
                 gender  + 
                 age  + 
                 race +
                 specialty +
                 discharge +
                 admission_source_id +
                 log_time_hosp   + 
                 
                 log_num_lab +
                # standardized_num_lab +
                 log_num_med +
                 diabetesMed,
               data = train_set_balanced2, 
               method = "glm",
               family = binomial,
               trControl = TC)

# model summary
summary(model)

# predictions
testsetpreds.LR <- predict(model, test_set2)
table( testsetpreds.LR, test_set2$readmitted)


# Calculate confusion matrix- using dummy te
test_set2$readmitted_2<- as.factor(test_set2$readmitted)
cm1 <- confusionMatrix(testsetpreds.LR, reference = test_set2$readmitted_2, positive = "1")
print(cm1)

```

When including records with readmission = '\> 30':

-   Accuracy: 0.591

-   Specificity: 0.5930

-   Sensitivity: 0.5782

when omitting records of readmission = '\>30':

-   Accuracy: 0.6282

-   Specificity: 0.63874

-   Sensitivity: 0.51965

To enhance model sensitivity, records of patients readmitted 1-6 months
after their encounter were excluded from the dataset to focus on
obtaining more accurate insights.

### save dfC

```{r}

write.csv(dfC, "dfC")
```

